# URL 단축기

## 문제

### tiny url 같은 URL 단축기를 설계하라

## 1단계

### 할 수 있는 질문

<details>
    <summary>펼쳐보기</summary>

1. 어떻게 동작하는지 예시를 보여달라
2. 트래픽의 규모는?
3. 단축 URL의 길이는 어느 정도여야 하는가?
4. 단축 URL에 포함될 문제에 제한이 있는지?
5. 단축 URL을 시스템에서 지우거나 갱신할 수 있는지?
6. 몇년 간 운영하는지?

</details>

### 면접관의 답변 예시

<details>
    <summary>펼쳐보기</summary>

1. 엄청 긴 URL을 ~/q4jz5j로 단축
2. 매일 1억개의 단축 url을 생성할 정도
3. 짧으면 짧을수록 좋음
4. 숫자와 알파벳 대소문자로 제한
5. 삭제나 갱신 불가능
6. 10년으로 가정

</details>

### 개략적 추정

<details>
    <summary>펼쳐보기</summary>

- 쓰기 연산: 매일 1억 개의 단축 URL 생성
- 초당 쓰기: 1억 / 24 / 3600 = 1,160회
- 읽기 연산: 쓰기 연산의 10배라 가정 → 11,600회
- 총 보관 레코드: 1억 x 365일 x 10년 = 3650억 개
- 축약 전 URL의 길이가 100이라 가정 → 3650 x 100Byte = 36.5TB

</details>

## 2단계

### API End Point

- URL 단축용 API
  - path: `POST` /api/v1/data/shorten
  - param: longUrl
  - response: 단축 URL
- 리다이렉션용 URL
  - path: `GET` /api/v1/shortUrl
  - response: 원래 URL
- 관련 정보는 간단하게 `Hash Table`을 통해 구현 가능

<details>
    <summary>💡 301과 302 차이</summary>

- 301
  - Permanently Model
  - 해당 URL에 대한 HTTP 요청의 처리 책임이 `영구적`으로 Location 헤더에 반환된 URL로 이전되었다는 응답
  - 영구적으로 이전되었으므로, 브라우저는 이 응답을 `캐싱`함
  - 서버 부하가 줄어듦
- 302
  - Found
  - 주어진 URL로의 요청이 `일시적`으로 Location 헤더가 지정하는 URL에 의해 처리돼야 한다는 응답
  - 트래픽 분석이 중요할 때(클릭률, 발생 위치 분석) 활용

</details>

## 3단계

### 데이터 모델

- 해시 테이블의 문제점
  - 메모리가 `유한`하고 비쌈
  - 분산 환경에서 활용하기 힘듦
- RDB를 통한 설계하자.

| 구분 |   name   |
| :--: | :------: |
|  PK  |    id    |
|      | shortUrl |
|      | longUrl  |

### 해시 함수

- 해시 값 길이
  - 대문자 26개 + 소문자 26개 + 숫자 10개 = `62개`
  - 10년 간 저장할 URL의 갯수: 3650억개
  - `62^n >= 3650억`을 만족하는 n의 최솟값을 구해야 함
    - n=5 → 약 568억
    - `n=6` → 약 3.5조
- 해시 후 충돌 해소
  - 잘 알려진 CRC32, MD5, SHA-1
  - 모두 길이가 7을 넘음
  - 앞 7자리만 따서 저장하고, 충돌을 막기 위해 유효성 체크를 하자
  - DB에 부하가 커짐
  - 블룸 필터를 활용
    - 어떤 집합에 `특정 원소가 있는지` 검사할 수 있도록 하는 `공간 효율`이 좋은 기술

### base-62 변환

- 원본 URL의 문자를 10진법 수로 변환하여 ID 도출
- 이 ID는 유일성이 보장돼야 함
- 10진법 수를 62진법으로 변환
- DB Record로 만듦

### URL 리다이렉션 상세 설계

<p align=center>
    <img src='../resources/URL_단축기.png' width=1000>
</p>

- 쓰기보다 읽기 연산이 잦음 → 캐시 활용

## 4단계

- 처리율 제한 장치
- 웹 서버 규모 확장
  - 무상태 계층이므로, 이를 고려해야 함
- 데이터 분석 솔루션
  - 어떤 링크를 얼마나 많은 사용자가 클릭했는지
  - 언제 주로 클릭했는지
- 가용성, 데이터 일관성, 안정성
